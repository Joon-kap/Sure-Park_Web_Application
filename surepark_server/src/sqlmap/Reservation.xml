<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="com.ajou.cmu.reservation">
	<typeAlias alias ="RequestParameter" type="com.ajou.cmu.common.RequestParameter"/>		
	
	<typeAlias alias="rev" type="com.ajou.cmu.reservation.Reservation"/>
	
	<resultMap class="rev" id="revResult">
		<result property="revReserId" column="P_RESER_ID"/>
		<result property="revIdentifier" column="P_IDENTIFIER"/>
		<result property="revReserTelno" column="P_RESER_TELNO"/>
		<result property="revReserTime" column="P_RESER_TIME"/>
		<result property="revSpotNumber" column="P_SPOT_NUMBER"/>
		<result property="revPayMent" column="P_PAYMENT"/>
		<result property="revPayMentYn" column="P_PAYMENT_YN"/>
		<result property="revCancelYn" column="P_CANCEL_YN"/>
		<result property="revEnterTime" column="P_ENTER_TIME"/>
		<result property="revExitTime" column="P_EXIT_TIME"/>
		<result property="revCreateDt" column="P_CREATE_DT"/>
		<result property="revUpdateDt" column="P_UPDATE_DT"/>		
	</resultMap>
	
	<select id="selectParkingReservation" parameterClass="RequestParameter" resultMap="revResult">
	SELECT AA.TOTAL_QTY, BB.PARKED_QTY, AA.TOTAL_QTY - BB.PARKED_QTY AS AVABILE_QTY
  FROM 
	( SELECT MAX(P_AVAIBLE_QTY) AS TOTAL_QTY FROM P_CONFIG_INFO  ) AA,  
   ( SELECT COUNT(*) AS PARKED_QTY
     FROM P_RESER_MST
	 WHERE ( P_SPOT_NUMBER IS NOT NULL AND P_PAYMENT_YN IS NULL )
	   OR  ( P_IDENTIFIER IS NOT NULL AND P_SPOT_NUMBER IS NULL ))
	   AND SUBSTR(P_RESER_TIME,1,8) = '20160717' ) BB 

	</select>
	
	<select id="selectIdentifiers" parameterClass="RequestParameter" resultMap="revResult">
		SELECT P_IDENTIFIER FROM P_RESER_MST
 		WHERE P_IDENTIFIER IS NOT NULL  
   		AND P_SPOT_NUMBER IS NULL
   	</select>
	
	<insert id="insertPakingReservation" parameterClass="RequestParameter">
		 INSERT INTO p_reser_mst(
			P_RESER_ID,
			P_IDENTIFIER,
			P_RESER_TELNO,
			P_RESER_TIME,
			P_SPOT_NUMBER,
			P_PAYMENT,
			P_PAYMENT_YN,
			P_CANCEL_YN,
			P_ENTER_TIME,
			P_EXIT_TIME,
			P_CREATE_DT,
			P_UPDATE_DT)
		VALUE(
			(select *from (select max(P_RESER_ID)+1 from p_reser_mst) next),
			/*#pIdentifier#,*/
			'RT11119999ET07171200',
			/*#pReserTelno#,*/
			'01011119999',
			/*#pReserTime#,*/
			'201607171200',
			#pSpotNumber#,
			#pPayment#,
			#pPaymentYn#,
			#pCancelYn#,
			now(),
			now(),			
			now(),
			now())
	</insert>
	
	<update id="updatePakingReservation" parameterClass="RequestParameter">
		 Update p_reser_mst
   			set p_spot_number  = ifnull(#pSpotNumber#,'3'),
   				/*p_spot_number  = ifnull(#pSpotNumber#,'3'),*/
   			    P_enter_time   = new()
         Where substr(p_identifier,3,8) = '22128783'
  		/* substr(p_identifier,3,8)  = #pIdentifier# */
  		/* and p_reser_time = #pReserTime */
	</update>

</sqlMap>
