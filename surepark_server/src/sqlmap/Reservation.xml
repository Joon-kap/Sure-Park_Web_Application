<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="com.ajou.cmu.reservation">
	<typeAlias alias ="RequestParameter" type="com.ajou.cmu.common.RequestParameter"/>		
	
	<typeAlias alias="rev" type="com.ajou.cmu.reservation.Reservation"/>
	
	<resultMap class="rev" id="revResult">
		<result property="pReserId" column="P_RESER_ID"/>
		<result property="pIdentifier" column="P_IDENTIFIER"/>
		<result property="pReserTelno" column="P_RESER_TELNO"/>
		<result property="pReserTime" column="P_RESER_TIME"/>
		<result property="pSpotNumber" column="P_SPOT_NUMBER"/>
		<result property="pPayment" column="P_PAYMENT"/>
		<result property="pPaymentYn" column="P_PAYMENT_YN"/>
		<result property="pCancelYn" column="P_CANCEL_YN"/>
		<result property="pEnterTime" column="P_ENTER_TIME"/>
		<result property="pExitTime" column="P_EXIT_TIME"/>
		<result property="pCreateDt" column="P_CREATE_DT"/>
		<result property="pUpdateDt" column="P_UPDATE_DT"/>		
	</resultMap>
	
	
	
	<select id="selectParkingReservation" resultClass="java.util.HashMap">
	SELECT AA.TOTAL_QTY,
           BB.PARKED_QTY, 
           AA.TOTAL_QTY - BB.PARKED_QTY AS AVABILE_QTY
  	  FROM
      (
        ( SELECT MAX(P_AVAIBLE_QTY) AS TOTAL_QTY
          FROM P_CONFIG_INFO  ) AA,  
        ( SELECT COUNT(*) AS PARKED_QTY
             FROM P_RESER_MST
         WHERE ( P_SPOT_NUMBER IS NOT NULL AND P_PAYMENT_YN IS NULL )
            OR  ( P_IDENTIFIER IS NOT NULL AND P_SPOT_NUMBER IS NULL ))BB
       )

	</select>
	
	<select id="selectIdentifiers" parameterClass="RequestParameter" resultMap="revResult">
		SELECT  CASE COUNT(*) WHEN 0 THEN 'NOT RESERVED'
									 WHEN 1 THEN 'APPROVED' 
									 ELSE 'ERROR' END
		  FROM P_RESER_MST
 		WHERE P_IDENTIFIER = 'RE22128783RT07171100'
   		AND P_SPOT_NUMBER IS NULL
   	</select>
   	
   	
   	<!-- 대한 - 2016.07.18 13:12 - CurrentStateController에서 현재 주차장에 입차한 사용자의 정보를 보내기위한 쿼리 작성 --> 
   	<select id="selectcurrentstatus" parameterClass="RequestParameter" resultMap="revResult">
   		SELECT 
   		P_SPOT_NUMBER,
   		P_ENTER_TIME,
   		
   		FROM P_RESER_MST
   		
   		WHERE P_RESER_ID = '요청에서 들어온 RESER_ID = requestparameter'
   	</select>
	
	<insert id="insertPakingReservation" parameterClass="RequestParameter">
		 INSERT INTO p_reser_mst(
			P_IDENTIFIER,
			P_RESER_TELNO,
			P_RESER_TIME,
			P_CREATE_DT,
			P_UPDATE_DT)
		VALUE(
			#pIdentifier#,
			#pReserTelno#,
			#pReserTime#,
			now(),
			now())
	</insert>
	
	<update id="updatePakingReservation" parameterClass="RequestParameter">
		 Update p_reser_mst
   			set p_spot_number  = '3',   				
   			    P_enter_time   = new()
         Where p_identifier = 'RE22128783RT07171100'
           and p_spot_number is null
	</update>

</sqlMap>
